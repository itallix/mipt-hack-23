# Telegram Bot powered by Gemini Pro

## Prerequisites

1. [poetry](https://python-poetry.org/docs/)

    <!-- markdownlint-disable MD013 -->
    ```bash
    curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | python -
    ```

1. [ngrok](https://ngrok.com/)

    ```bash
    brew install ngrok
    ```

1. [pre-commit](https://pre-commit.com/)

    ```bash
    brew install pre-commit
    pre-commit install
    ```

1. [gcloud](https://cloud.google.com/sdk/docs/install)

    ```bash
    brew install --cask google-cloud-sdk
    ```

## Running jupyterlab

```bash
poetry install
poetry run jupyter lab
```

## Running bot locally

1. Make sure you have access to the Google project `mipt-hack-01` (contact tg: @fancyeagle if not)

   ```bash
   gcloud auth application-default login
   ```

1. Register your bot for testing with [BotFather](https://t.me/BotFather) and save a telegram token as env variable:

    ```bash
    export TELEGRAM_TOKEN=some_value
    ```

1. If you didn't create a virtual environment with poetry before, create it:

    ```bash
    poetry install
    ```

1. Execute the following commands in terminal to start bot service locally:

    ```bash
    export FLASK_APP=bot_service.app:app
    export FLASK_RUN_PORT=5005
    export FLASK_ENV=development
    export PROJECT_ID=mipt-hack-01
    poetry run flask run --reload
    ```

1. Create a tunnel for the local HTTP server from the previous step using `ngrok`, making it accessible from the
public internet:

    ```bash
    ngrok http 127.0.0.1:5005
    ```

1. Using `sh/webhook.sh` script, register the webhook with Telegram API, so that the bot will trigger local service
on each request:

    ```bash
    sh sh/webhook.sh set <PUBLIC_URL> <TELEGRAM_TOKEN>
    ```

    - `PUBLIC_URL` - the url generated by ngrok on step 4, e.g.: `https://fce9-2a02-a447-94fc-1-50f5-8a25-6ab-eecc.ngrok.io`
    - `TELEGRAM_TOKEN` - the token generated by BotFather on step 1

1. After you finished with testing, you can disconnect your bot using the following command:

    ```bash
    sh sh/webook.sh delete <TELEGRAM_TOKEN>
    ```
